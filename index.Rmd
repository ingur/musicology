---
title: "Portfolio"
author: "Ingur Veken"
date: "21/02/2021"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: fill
    horizontal_layout: fill
    orientation: columns
    storyboard: true
    theme: journal
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
load("anime2.RDATA")

library(flexdashboard)
library(protoclust)
library(tidymodels)
library(tidyverse)
library(heatmaply)
library(gridExtra)
library(spotifyr)
library(ggdendro)
library(ggthemes)
library(compmus)
library(ggplot2)
library(ggpubr)
library(plotly)
library(dplyr)

theme_set(theme_hc())
```


Introduction
=========================================

> <center>PLEASE DO NOT SHOW THIS PORTFOLIO IN CLASS</center>

Japanese animation - also known as Anime - has grown immensely as both an industry and art form over the years. Music has played a big part in this growth, as the intro and credits have always been accompanied by a song. First appearing in 1963 together with the release of Astro Boy, anime music quickly developed into a musical genre in its own right. 
Spotify released four playlists called "Anime Rewind" for every decade between the '80s and the '10s.  These playlists make up the corpus of 181 selected hit songs released during this time. My main goal is to analyze how anime music has evolved over the years, and I believe this corpus allows me to do so. 

There are multiple possible comparison points from influential artists to song features like `danceability` and `speechiness`/`loudness`. The corpus includes most of the popular hit songs and seems to cover the genre appropriately. The only limitations are that there are no songs from the '60s and '70s, and there might still be a few tracks left that are not included in the original playlists by Spotify.

There are multiple tracks to keep in mind, such as 'A Cruel Angel's Thesis' (1995) and 'Hare Hare Yukai' (2006). These tracks were not only successful but are also said to have established new styles of Anime songs. We will pay close attention to these songs, as well as 'Touch' (1985) and 'Crossing Field' (2012) since both songs were very popular and because I loved watching both shows while growing up. 

Links to the Spotify playlists:

```{=html}
<div style="display:flex;justify-content:flex-start;max-width:100%;flex-wrap:wrap;">
<object data="https://open.spotify.com/embed/playlist/37i9dQZF1DXcFCZS9poESZ" width="300" height="380" style="display:block;margin:auto;width:25%;min-width:300px">
    <embed src="https://open.spotify.com/embed/playlist/37i9dQZF1DXcFCZS9poESZ" width="300" height="380"></embed>
</object>
<object data="https://open.spotify.com/embed/playlist/37i9dQZF1DXanOaZVFiwtB" width="300" height="380" style="display:block;margin:auto;width:25%;min-width:300px">
    <embed src="https://open.spotify.com/embed/playlist/37i9dQZF1DXanOaZVFiwtB" width="300" height="380"></embed>
</object>
<object data="https://open.spotify.com/embed/playlist/37i9dQZF1DWZZu9JWZK2dy" width="300" height="380" style="display:block;margin:auto;width:25%;min-width:300px">
    <embed src="https://open.spotify.com/embed/playlist/37i9dQZF1DWZZu9JWZK2dy" width="300" height="380"></embed>
</object>
<object data="https://open.spotify.com/embed/playlist/37i9dQZF1DWYzHfIcEruXw" width="300" height="380" style="display:block;margin:auto;width:25%;min-width:300px">
    <embed src="https://open.spotify.com/embed/playlist/37i9dQZF1DWYzHfIcEruXw" width="300" height="380"></embed>
</object>
</div>
```

<!-- <iframe src="https://open.spotify.com/embed/playlist/37i9dQZF1DXcFCZS9poESZ" width="300" height="380" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe> -->

<!-- <iframe src="https://open.spotify.com/embed/playlist/37i9dQZF1DXanOaZVFiwtB" width="300" height="380" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe> -->

<!-- <iframe src="https://open.spotify.com/embed/playlist/37i9dQZF1DWZZu9JWZK2dy" width="300" height="380" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe> -->

<!-- <iframe src="https://open.spotify.com/embed/playlist/37i9dQZF1DWYzHfIcEruXw" width="300" height="380" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe> -->

<!-- - [Anime Rewind '80s](https://open.spotify.com/playlist/37i9dQZF1DXcFCZS9poESZ?si=X78joBOfSNybC2_h2ywCBQ) -->
<!-- - [Anime Rewind '90s](https://open.spotify.com/playlist/37i9dQZF1DXanOaZVFiwtB?si=cBGaz_VxRRW14iXdNAFQ8g) -->
<!-- - [Anime Rewind '00s](https://open.spotify.com/playlist/37i9dQZF1DWZZu9JWZK2dy?si=wPjUpf9pSSST3NhlYnkxjQ) -->
<!-- - [Anime Rewind '10s](https://open.spotify.com/playlist/37i9dQZF1DWYzHfIcEruXw?si=77LFyMfiSLSIwtcEN66MHw) -->

Track-level {.storyboard}
=========================================

### Danceability per decennia

```{r, echo=FALSE}
danceability_plot <- anime %>%
  ggplot(aes(category, danceability)) +
    geom_boxplot(aes(fill = category)) + 
    labs(
      title = "Danceability per decennia",
      x = NULL,
      y = NULL
    ) + 
    theme_minimal() + 
    theme(
      legend.position = "none",
      plot.title = element_text(hjust = 0.5)
    )

ggplotly(danceability_plot)
```

***

Let us first take a look at the average `danceability`. 
As we can see in the plot there has been a slight decline on average the past 
four decades. Spotify bases the `danceability` score on a combination of musical
elements including tempo, rhythm stability, beat strength, and overall regularity.
A value of 1.0 indicates a most danceable song. I initially believed rhythm stability
was the deciding factor, since anime songs, especially those from the 80s and 90s, 
are well known for having a very stable beat (on average). We will analyse this 
further during our temporal analysis.

### Speechiness per decennia

```{r, echo=FALSE}
speechiness_plot <- anime %>%
  ggplot(aes(category, speechiness)) +
    geom_boxplot(aes(fill = category)) + 
    labs(
      title = "Speechiness per decennia",
      x = NULL,
      y = NULL
    ) + 
  theme_minimal() + 
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5)
  )

ggplotly(speechiness_plot)
```

***

As we can see in this plot, `speechiness` has increased on average over the past 4 
decades. However, not by much. `speechiness` indicates the presence of spoken words
in a track. Talk-shows usually score high values above 0.66, while most rap songs tend 
to get a score between 0.33 and 0.66. Interestingly enough, not a single song in our corpus got a 
value above 0.30.

### Loudness per decennia

```{r, echo=FALSE}
loudness_plot <- anime %>%
  ggplot(aes(category, loudness)) +
    geom_boxplot(aes(fill = category)) + 
    labs(
      title = "Loudness per decennia",
      x = NULL,
      y = NULL
    ) + 
  theme_minimal() + 
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5)
  )

ggplotly(loudness_plot)
```

***

As a direct result of the so-called 'Loudness war', the overall `loudness` in decibels (dB)
has increased steadily. The average `loudness` in anime music has has gone from almost -7 to nearly -3 dB.
The Loudness war affected almost every music genre starting as early as the 1940s, so it is not a surprise
to see this effect apply to anime songs as well.


Chroma Features {.storyboard}
=========================================


### Chromagram of 'Touch' (80s)

```{r, echo=FALSE}

# crossing <-
#   get_tidy_audio_analysis("5RsRhryZD9FdTmxsAaZ2mM")
# 
# crossing_features <-
#   crossing %>%
#   compmus_align(bars, segments) %>%
#   select(bars) %>%
#   unnest(bars) %>%
#   mutate(
#     pitches =
#       map(segments,
#         compmus_summarise, pitches,
#         method = "acentre", norm = "manhattan"
#       )
#   ) %>%
#   mutate(
#     timbre =
#       map(segments,
#         compmus_summarise, timbre,
#         method = "mean"
#       )
#   )


# touch_chromagram <-
#   touch_features %>%
#   mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>%
#   compmus_gather_chroma() %>%
#   ggplot(
#     aes(
#       x = start + duration / 2,
#       width = duration,
#       y = pitch_class,
#       fill = value
#     )
#   ) +
#   geom_tile() +
#   labs(x = NULL, y = NULL, fill = "Magnitude", title="'Touch' (80s)") +
#   theme_minimal() +
#   scale_fill_viridis_c() + 
#   theme(
#     plot.title = element_text(hjust = 0.5),
#   )
# 
# evangelion_chromagram <-
#   evangelion_features %>%
#   mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>%
#   compmus_gather_chroma() %>%
#   ggplot(
#     aes(
#       x = start + duration / 2,
#       width = duration,
#       y = pitch_class,
#       fill = value
#     )
#   ) +
#   geom_tile() +
#   labs(x = NULL, y = NULL, fill = "Magnitude", title = "'A Cruel Angel's Thesis' (90s)") +
#   theme_minimal() +
#   scale_fill_viridis_c() +
#   theme(
#     plot.title = element_text(hjust = 0.5),
#     # axis.text.y = element_blank(),
#     # axis.ticks.y = element_blank(),
#     # axis.title.y = element_blank()
#   )
# 
# hare_hare_chromagram <-
#   hare_hare_features %>%
#   mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>%
#   compmus_gather_chroma() %>%
#   ggplot(
#     aes(
#       x = start + duration / 2,
#       width = duration,
#       y = pitch_class,
#       fill = value
#     )
#   ) +
#   geom_tile() +
#   labs(x = NULL, y = NULL, fill = "Magnitude", title="'Hare Hare Yukai' (00s)") +
#   theme_minimal() +
#   scale_fill_viridis_c() +
#   theme(
#     plot.title = element_text(hjust = 0.5),
#   )
# 
# crossing_chromagram <-
#   crossing_features %>%
#   mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>%
#   compmus_gather_chroma() %>%
#   ggplot(
#     aes(
#       x = start + duration / 2,
#       width = duration,
#       y = pitch_class,
#       fill = value
#     )
#   ) +
#   geom_tile() +
#   labs(x = NULL, y = NULL, fill = "Magnitude", title = "'Crossing Field' (10s)") +
#   theme_minimal() +
#   scale_fill_viridis_c() +
#   theme(
#     plot.title = element_text(hjust = 0.5),
#     # axis.text.y = element_blank(),
#     # axis.ticks.y = element_blank(),
#     # axis.title.y = element_blank()
#   )


# ggarrange(touch_chromagram, evangelion_chromagram, hare_hare_chromagram, crossing_chromagram, nrow = 2, ncol = 2, common.legend = TRUE)

touch_chromagram
```

***

```{=html}
<img src="https://cdn.myanimelist.net/images/anime/3/53087.jpg" style="width:100%;max-width:282px"/>
<object data="https://open.spotify.com/embed/track/1EvVwqTga8655SrGAS6Zba" width="282" height="80" style="display:block;width:282px;margin-bottom:8px;">
    <embed src="https://open.spotify.com/embed/track/1EvVwqTga8655SrGAS6Zba" width="282" height="80"></embed>
</object>
```

Touch was the first opening song for the anime with the same name that aired from 1985 to 1987. The song is written in the key of B Minor.
The main chord progression is B-Em-A-D-F# and stays fairly consistent throughout the song, with the occasional G and C# chord being played instead of the 
F# chord for some variety to keep the listener interesting. Truly a consistent anime song as is characteristic for the 80s.

### Chromagram of 'A Cruel Angel's Thesis' (90s)

```{r, echo=FALSE}
evangelion_chromagram
```

***

```{=html}
<img src="https://cdn.myanimelist.net/images/anime/1314/108941.jpg" style="width:100%;max-width:282px"/>
<object data="https://open.spotify.com/embed/track/3dDZFJSvdT9N2nNAdsE9j2" width="282" height="80" style="display:block;width:282px;margin-bottom:8px;">
    <embed src="https://open.spotify.com/embed/track/3dDZFJSvdT9N2nNAdsE9j2" width="282" height="80"></embed>
</object>
```

This is one of, if not the most famous anime song to have ever been created, 
and appears as the opening song in "Neon Genesis Evangelion". Can the chord progression 
help explain why this song is considered to be such a classic?
The song is written in C minor, and is correctly identified by spotify. 
The Intro chorus is essentialy a shorter and more quiet version of the main chorus,
and acts like a teaser that only gives a small taste of the real chorus.

Both the verse and pre-chorus trick us into thinking the chorus is coming by not
resolving the unstable chords to where we expect them to go (the C "release" tonic).
This leaves us hearing the G (dominant) chord that builds tension being prolonged
by the Eb and Ab tension chords (mediant and submediant), further keeping us interested
and making us want the chorus even more. It's this way of teasing the listener that 
keeps having people come back to this song even 26 years later.

The intro chorus progression is: C-F-Bb-Eb-C-F-Bb-Ab

The main chorus progression is:  C-F-Bb-Eb-C-F-Bb-C

The verse chord progression is: Eb-Bb-C-Bb-Ab and Bb-Eb-C-D-F-G

The pre-chorus progression is: Ab-G-C-F-Bb-Bb-Eb

### Chromagram of 'Hare Hare Yukai' (00s)

```{r, echo=FALSE}
hare_hare_chromagram
```

***

```{=html}
<img src="https://cdn.myanimelist.net/images/anime/8/75377.jpg" style="width:100%;max-width:282px"/>
<object data="https://open.spotify.com/embed/track/651dM1w0QS5qG1qdL2zraO" width="282" height="80" style="display:block;width:282px;margin-bottom:8px;">
    <embed src="https://open.spotify.com/embed/track/651dM1w0QS5qG1qdL2zraO" width="282" height="80"></embed>
</object>
```

This is an ending song of the anime "The Melancholy of Haruhi Suzumiya" that aired in 2006. What makes this song so special
is that it is the first anime theme ever that had the characters dance to it during the ending credits. This sparked a whole
new subgenre of anime idol songs that really exploded in the 10s. The song is written in Ab Major but really plays around the 
dominant (V) C chord a lot, which also shows up a lot in the chordogram. 

### Chromagram of 'Crossing Field' (10s)

```{r, echo=FALSE}
crossing_chromagram
```

***

```{=html}
<img src="https://cdn.myanimelist.net/images/anime/11/39717.jpg" style="width:100%;max-width:282px"/>
<object data="https://open.spotify.com/embed/track/3mScGCzxiXA9OaHdBeuk7O" width="282" height="80" style="display:block;width:282px;margin-bottom:8px;">
    <embed src="https://open.spotify.com/embed/track/3mScGCzxiXA9OaHdBeuk7O" width="282" height="80"></embed>
</object>
```

This is personally one of my favorite songs in the corpus, simply because it was the first anime song I really listened to. 
The song is written in F Major, which can also be faintly seen in the chordogram. Spotify is not as sure as with the other songs here.
The song also has a part where it mostly plays in A# because of a guitar solo. 

Self-Similarity {.storyboard}
=========================================

### Self-Similarity Matrices of 'Touch' (80s)

```{r, echo=FALSE}
# evangelion_features <-
#   evangelion %>%
#   compmus_align(bars, segments) %>%
#   select(bars) %>%
#   unnest(bars) %>%
#   mutate(
#     pitches =
#       map(segments,
#         compmus_summarise, pitches,
#         method = "acentre", norm = "manhattan"
#       )
#   ) %>%
#   mutate(
#     timbre =
#       map(segments,
#         compmus_summarise, timbre,
#         method = "mean"
#       )
#   )

# touch_chroma_timbre <-
#   bind_rows(
#   touch_features %>%
#     compmus_self_similarity(pitches, "aitchison") %>%
#     mutate(d = d / max(d), type = "Chroma"),
#   touch_features %>%
#     compmus_self_similarity(timbre, "euclidean") %>%
#     mutate(d = d / max(d), type = "Timbre")
# ) %>%
#   mutate() %>%
#   ggplot(
#     aes(
#       x = xstart + xduration / 2,
#       width = xduration,
#       y = ystart + yduration / 2,
#       height = yduration,
#       fill = d
#     )
#   ) +
#   geom_tile() +
#   coord_fixed() +
#   facet_wrap(~type) +
#   scale_fill_viridis_c(option = "E", guide = "none") +
#   theme_minimal() +
#   labs(x = NULL, y = NULL, title = "'Touch' (80s)") +
#   theme(
#     plot.title = element_text(hjust = 0.5)
#   )
# 
# evangelion_chroma_timbre <-
#   bind_rows(
#   evangelion_features %>%
#     compmus_self_similarity(pitches, "aitchison") %>%
#     mutate(d = d / max(d), type = "Chroma"),
#   evangelion_features %>%
#     compmus_self_similarity(timbre, "euclidean") %>%
#     mutate(d = d / max(d), type = "Timbre")
# ) %>%
#   mutate() %>%
#   ggplot(
#     aes(
#       x = xstart + xduration / 2,
#       width = xduration,
#       y = ystart + yduration / 2,
#       height = yduration,
#       fill = d
#     )
#   ) +
#   geom_tile() +
#   coord_fixed() +
#   facet_wrap(~type) +
#   scale_fill_viridis_c(option = "E", guide = "none") +
#   theme_minimal() +
#   labs(x = NULL, y = NULL, title = "'A Cruel Angel's Thesis' (90s)") +
#   theme(
#     plot.title = element_text(hjust = 0.5)
#   )
# 
# hare_hare_chroma_timbre <-
#   bind_rows(
#   hare_hare_features %>%
#     compmus_self_similarity(pitches, "aitchison") %>%
#     mutate(d = d / max(d), type = "Chroma"),
#   hare_hare_features %>%
#     compmus_self_similarity(timbre, "euclidean") %>%
#     mutate(d = d / max(d), type = "Timbre")
# ) %>%
#   mutate() %>%
#   ggplot(
#     aes(
#       x = xstart + xduration / 2,
#       width = xduration,
#       y = ystart + yduration / 2,
#       height = yduration,
#       fill = d
#     )
#   ) +
#   geom_tile() +
#   coord_fixed() +
#   facet_wrap(~type) +
#   scale_fill_viridis_c(option = "E", guide = "none") +
#   theme_minimal() +
#   labs(x = NULL, y = NULL, title = "'Hare Hare Yukai' (00s)") +
#   theme(
#     plot.title = element_text(hjust = 0.5)
#   )
# 
# crossing_chroma_timbre <-
#   bind_rows(
#   crossing_features %>%
#     compmus_self_similarity(pitches, "aitchison") %>%
#     mutate(d = d / max(d), type = "Chroma"),
#   crossing_features %>%
#     compmus_self_similarity(timbre, "euclidean") %>%
#     mutate(d = d / max(d), type = "Timbre")
# ) %>%
#   mutate() %>%
#   ggplot(
#     aes(
#       x = xstart + xduration / 2,
#       width = xduration,
#       y = ystart + yduration / 2,
#       height = yduration,
#       fill = d
#     )
#   ) +
#   geom_tile() +
#   coord_fixed() +
#   facet_wrap(~type) +
#   scale_fill_viridis_c(option = "E", guide = "none") +
#   theme_minimal() +
#   labs(x = NULL, y = NULL, title = "'Crossing Field' (10s)") +
#   theme(
#     plot.title = element_text(hjust = 0.5),
#   )

# ggarrange(touch_chroma_timbre, evangelion_chroma_timbre, hare_hare_chroma_timbre, crossing_chroma_timbre, nrow = 2, ncol = 2, common.legend = TRUE)
touch_chroma_timbre
```

***

```{=html}
<img src="https://cdn.myanimelist.net/images/anime/3/53087.jpg" style="width:100%;max-width:282px"/>
<object data="https://open.spotify.com/embed/track/1EvVwqTga8655SrGAS6Zba" width="282" height="80" style="display:block;width:282px;margin-bottom:8px;">
    <embed src="https://open.spotify.com/embed/track/1EvVwqTga8655SrGAS6Zba" width="282" height="80"></embed>
</object>
```

The consistency of the 80s anime song really shows itself here again. 
You can clearly see the returning chorus and verses in the diagonal lines, very
nicely detected by Spotify. The bridge is also detected after the first main chorus
(The 'cross' between around 75-95 seconds) in the Timbre matrix. These matrices are
not very useful to compare the different decades though.

### Self-Similarity Matrices of 'A Cruel Angel's Thesis' (90s)

```{r, echo=FALSE}
evangelion_chroma_timbre
```

***

```{=html}
<img src="https://cdn.myanimelist.net/images/anime/1314/108941.jpg" style="width:100%;max-width:282px"/>
<object data="https://open.spotify.com/embed/track/3dDZFJSvdT9N2nNAdsE9j2" width="282" height="80" style="display:block;width:282px;margin-bottom:8px;">
    <embed src="https://open.spotify.com/embed/track/3dDZFJSvdT9N2nNAdsE9j2" width="282" height="80"></embed>
</object>
```

Timestamps you can identify:

- The "Angel Voices" 0-14 (0:00-0:14)
- The chorus "Teaser" 15-22 (0:15-0:22)
- The first chorus 68-90 (1:08-1:30)
- The shorter second chorus 120-135 (2:00-2:15)
- The third chorus 180-202 (3:00-3:22)
- The final chorus 218-240 (3:38-4:00)

(The verses and pre-chorus in between)

The Angel voices at the start make up a big contrast for the rest of the self-similarity matrix since it's so different from the rest of the song.
This pattern of having one very short and unique part in the song is pretty common as we will see in the other plots. 

### Self-similarity Matrices of 'Hare Hare Yukai' (00s)

```{r, echo=FALSE}
hare_hare_chroma_timbre
```

***

```{=html}
<img src="https://cdn.myanimelist.net/images/anime/8/75377.jpg" style="width:100%;max-width:282px"/>
<object data="https://open.spotify.com/embed/track/651dM1w0QS5qG1qdL2zraO" width="282" height="80" style="display:block;width:282px;margin-bottom:8px;">
    <embed src="https://open.spotify.com/embed/track/651dM1w0QS5qG1qdL2zraO" width="282" height="80"></embed>
</object>
```

This song is more like Touch, as it has a lot of consistent repeating parts that are easily recognizable. 
It also has a very recognizable guitar solo that can be seen in the Timbre matrix at around 150 seconds.

### Self-Similarity Matrices of 'Crossing Field' (10s)

```{r, echo=FALSE}
crossing_chroma_timbre
```

***

```{=html}
<img src="https://cdn.myanimelist.net/images/anime/11/39717.jpg" style="width:100%;max-width:282px"/>
<object data="https://open.spotify.com/embed/track/3mScGCzxiXA9OaHdBeuk7O" width="282" height="80" style="display:block;width:282px;margin-bottom:8px;">
    <embed src="https://open.spotify.com/embed/track/3mScGCzxiXA9OaHdBeuk7O" width="282" height="80"></embed>
</object>
```

Just as with Hare Hare Yukai, this song has a very easily recognizable guitar solo bridge that can be easily seen
around 175 seconds into the song. Other repeating parts are less visible as a result. This song also has a lot of unique 
pre-chorus transitions and bridges that don't re-appear later in the song.

Chord/Key Analysis {.storyboard}
=========================================

### Chordogram of 'Touch' (80s)

```{r, echo=FALSE}
# touch_tonal <-
#   touch %>%
#       compmus_align(sections, segments) %>%
#     select(sections) %>% unnest(sections) %>%
#     mutate(
#         pitches =
#             map(segments,
#                 compmus_summarise, pitches,
#                 method = 'acentre', norm = 'manhattan')) %>%
#     compmus_match_pitch_template(key_templates, 'aitchison', 'manhattan') %>%
#     ggplot(
#         aes(x = start + duration / 2, width = duration, y = name, fill = d)) +
#     geom_tile() +
#     scale_fill_viridis_c(option = 'E', guide = "none") +
#     theme_minimal() +
#     labs(x = 'Time (s)', y = '', fill = 'Distance', title = "'Touch' (80s)") + 
#     theme(
#       plot.title = element_text(hjust = 0.5)
#     )

touch_tonal
```

***

```{=html}
<img src="https://cdn.myanimelist.net/images/anime/3/53087.jpg" style="width:100%;max-width:282px"/>
<object data="https://open.spotify.com/embed/track/1EvVwqTga8655SrGAS6Zba" width="282" height="80" style="display:block;width:282px;margin-bottom:8px;">
    <embed src="https://open.spotify.com/embed/track/1EvVwqTga8655SrGAS6Zba" width="282" height="80"></embed>
</object>
```


The keygram at the left shows the modulations in Touch. Segmentation is done according to Spotify’s estimates, and the distances represented are Aitchison distances from Spotify’s chroma vectors to the original Krumhansl–Kessler key profiles (1990). The key can be correctly identified from the keygram (Bb:min). 

### Tonal Analysis of 'A Cruel Angel's Thesis' (90s)

```{r, echo=FALSE}
# circshift <- function(v, n) {if (n == 0) v else c(tail(v, n), head(v, -n))}
#                                     
# major_key <- 
#     c(6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88)
# minor_key <-
#     c(6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17)
# key_templates <-
#     tribble(
#         ~name    , ~template,
#         'Gb:maj', circshift(major_key,  6),
#         'Bb:min', circshift(minor_key, 10),
#         'Db:maj', circshift(major_key,  1),
#         'F:min' , circshift(minor_key,  5),
#         'Ab:maj', circshift(major_key,  8),
#         'C:min' , circshift(minor_key,  0),
#         'Eb:maj', circshift(major_key,  3),
#         'G:min' , circshift(minor_key,  7),
#         'Bb:maj', circshift(major_key, 10),
#         'D:min' , circshift(minor_key,  2),
#         'F:maj' , circshift(major_key,  5),
#         'A:min' , circshift(minor_key,  9),
#         'C:maj' , circshift(major_key,  0),
#         'E:min' , circshift(minor_key,  4),
#         'G:maj' , circshift(major_key,  7),
#         'B:min' , circshift(minor_key, 11),
#         'D:maj' , circshift(major_key,  2),
#         'F#:min', circshift(minor_key,  6),
#         'A:maj' , circshift(major_key,  9),
#         'C#:min', circshift(minor_key,  1),
#         'E:maj' , circshift(major_key,  4),
#         'G#:min', circshift(minor_key,  8),
#         'B:maj' , circshift(major_key, 11),
#         'D#:min', circshift(minor_key,  3))

# evangelion_tonal <-
#   evangelion %>%
#       compmus_align(sections, segments) %>%
#     select(sections) %>% unnest(sections) %>%
#     mutate(
#         pitches =
#             map(segments,
#                 compmus_summarise, pitches,
#                 method = 'acentre', norm = 'manhattan')) %>%
#     compmus_match_pitch_template(key_templates, 'aitchison', 'manhattan') %>%
#     ggplot(
#         aes(x = start + duration / 2, width = duration, y = name, fill = d)) +
#     geom_tile() +
#     scale_fill_viridis_c(option = 'E', guide = "none") +
#     theme_minimal() +
#     labs(x = 'Time (s)', y = '', fill = 'Distance', title = "'A Cruel Angel's Thesis' (90s)") +
#     theme(
#       plot.title = element_text(hjust = 0.5)
#     )

evangelion_tonal

```

***

```{=html}
<img src="https://cdn.myanimelist.net/images/anime/1314/108941.jpg" style="width:100%;max-width:282px"/>
<object data="https://open.spotify.com/embed/track/3dDZFJSvdT9N2nNAdsE9j2" width="282" height="80" style="display:block;width:282px;margin-bottom:8px;">
    <embed src="https://open.spotify.com/embed/track/3dDZFJSvdT9N2nNAdsE9j2" width="282" height="80"></embed>
</object>
```


Due to the "Angel Voices" at the start of the song, Spotify has a harder time with this keygram. It makes it hard to see that the key is supposed to be C minor.

### Tonal Analysis of 'Hare Hare Yukai' (80s)

```{r, echo=FALSE}
# hare_hare_tonal <-
#   hare_hare %>%
#       compmus_align(sections, segments) %>%
#     select(sections) %>% unnest(sections) %>%
#     mutate(
#         pitches =
#             map(segments,
#                 compmus_summarise, pitches,
#                 method = 'acentre', norm = 'manhattan')) %>%
#     compmus_match_pitch_template(key_templates, 'aitchison', 'manhattan') %>%
#     ggplot(
#         aes(x = start + duration / 2, width = duration, y = name, fill = d)) +
#     geom_tile() +
#     scale_fill_viridis_c(option = 'E', guide = "none") +
#     theme_minimal() +
#     labs(x = 'Time (s)', y = '', fill = 'Distance', title = "'Hare Hare Yukai' (00s)") + 
#     theme(
#       plot.title = element_text(hjust = 0.5)
#     )

hare_hare_tonal
```

***

```{=html}
<img src="https://cdn.myanimelist.net/images/anime/8/75377.jpg" style="width:100%;max-width:282px"/>
<object data="https://open.spotify.com/embed/track/651dM1w0QS5qG1qdL2zraO" width="282" height="80" style="display:block;width:282px;margin-bottom:8px;">
    <embed src="https://open.spotify.com/embed/track/651dM1w0QS5qG1qdL2zraO" width="282" height="80"></embed>
</object>
```

Same as with the previous song, the key (Ab Major) is hard to see because of the guitar solo part that picks up most of the intensity on the graph. 

### Tonal Analysis of 'Crossing Field' (80s)

```{r, echo=FALSE}
# crossing_tonal <-
#   crossing %>%
#       compmus_align(sections, segments) %>%
#     select(sections) %>% unnest(sections) %>%
#     mutate(
#         pitches =
#             map(segments,
#                 compmus_summarise, pitches,
#                 method = 'acentre', norm = 'manhattan')) %>%
#     compmus_match_pitch_template(key_templates, 'aitchison', 'manhattan') %>%
#     ggplot(
#         aes(x = start + duration / 2, width = duration, y = name, fill = d)) +
#     geom_tile() +
#     scale_fill_viridis_c(option = 'E', guide = "none") +
#     theme_minimal() +
#     labs(x = 'Time (s)', y = '', fill = 'Distance', title = "'Crossing Field' (10s)") + 
#     theme(
#       plot.title = element_text(hjust = 0.5)
#     )

crossing_tonal
```

***

```{=html}
<img src="https://cdn.myanimelist.net/images/anime/11/39717.jpg" style="width:100%;max-width:282px"/>
<object data="https://open.spotify.com/embed/track/3mScGCzxiXA9OaHdBeuk7O" width="282" height="80" style="display:block;width:282px;margin-bottom:8px;">
    <embed src="https://open.spotify.com/embed/track/3mScGCzxiXA9OaHdBeuk7O" width="282" height="80"></embed>
</object>
```

This keygram got really weird, probably because of the long last guitar chord of the song that lasts for around 10 seconds until the end.

Tempograms {.storyboard}
=========================================

### Tempo in Anime Music

```{r, echo=FALSE, warning=FALSE}
ani_tempo <- ani %>% mutate(
    sections =
      map(
        sections,                                    # sections or segments
        summarise_at,
        vars(tempo, loudness, duration),             # features of interest
        list(section_mean = mean, section_sd = sd)   # aggregation functions
      )
  ) %>%
  unnest(sections) %>%
  ggplot(
    aes(
      x = tempo,
      y = tempo_section_sd,
      colour = playlist,
      alpha = loudness
    )
  ) +
  geom_point(aes(size = duration / 60)) +
  geom_rug() +
  theme_minimal() +
  ylim(0, 5) +
  labs(
    x = "Mean Tempo (bpm)",
    y = "SD Tempo",
    colour = "Playlist",
    size = "Duration (min)",
    alpha = "Volume (dBFS)",
    title = "Tempo in Anime Music"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
  ) +
  facet_wrap(~ playlist)

ani_tempo
```

***

This plot mostly shows how consistent the tempo is throughout anime songs. You can also clearly see how the mean tempo has
slightly increased over the past 40 years. This was hard to see when I initially plotted this in a single graph. 

### Tempogram of 'A Cruel Angel's Thesis' 


```{r, echo=FALSE}

# evangelion <-
#   get_tidy_audio_analysis("3dDZFJSvdT9N2nNAdsE9j2") 

# evangelion_tempogram <-
#   evangelion %>%
#     tempogram(window_size = 8, hop_size = 1, cyclic = FALSE) %>%
#     ggplot(aes(x = time, y = bpm, fill = power)) +
#     geom_raster() +
#     scale_fill_viridis_c(guide = "none") +
#     labs(x = "Time (s)", y = "Tempo (BPM)", title = "'A Cruel Angel's Thesis' (90s)") +
#     theme_minimal() + 
#     theme(
#       plot.title = element_text(hjust = 0.5)
#     )

evangelion_tempogram
```

***

```{=html}
<img src="https://cdn.myanimelist.net/images/anime/1314/108941.jpg" style="width:100%;max-width:282px"/>
<object data="https://open.spotify.com/embed/track/3dDZFJSvdT9N2nNAdsE9j2" width="282" height="80" style="display:block;width:282px;margin-bottom:8px;">
    <embed src="https://open.spotify.com/embed/track/3dDZFJSvdT9N2nNAdsE9j2" width="282" height="80"></embed>
</object>
```

The Fourier-based tempogram of A Cruel Angel's Thesis shows that the tempo is 
pretty much constant throughout the whole song. Spotify correctly estimates the
tempo of this track at 128 bpm. 

### Tempogram of Dang Dang (80s)


```{r, echo=FALSE}

# dang_dang <-
#   get_tidy_audio_analysis("11YTv3GEL4jjdjhiql2UP2") 

# dang_dang_tempogram <-
#   dang_dang %>%
#     tempogram(window_size = 8, hop_size = 1, cyclic = FALSE) %>%
#     ggplot(aes(x = time, y = bpm, fill = power)) +
#     geom_raster() +
#     scale_fill_viridis_c(guide = "none") +
#     labs(x = "Time (s)", y = "Tempo (BPM)", title = "'Dang dang' (80s)") +
#     theme_minimal() + 
#     theme(
#       plot.title = element_text(hjust = 0.5)
#     )

dang_dang_tempogram
```

***

```{=html}
<img src="https://cdn.myanimelist.net/images/anime/1681/109663.jpg" style="width:100%;max-width:282px"/>
<object data="https://open.spotify.com/embed/track/11YTv3GEL4jjdjhiql2UP2" width="282" height="80" style="display:block;width:282px;margin-bottom:8px;">
    <embed src="https://open.spotify.com/embed/track/11YTv3GEL4jjdjhiql2UP2" width="282" height="80"></embed>
</object>
```

Even in the 80s the tempo of most anime songs is constant throughout the whole
song and pretty easy for spotify to estimate and detect.

### Tempogram of Unravel (10s)


```{r, echo=FALSE}

# unravel <-
#   get_tidy_audio_analysis("5orAKrVdrk1kPtTa7zNvYL") 

# unravel_tempogram <-
#   unravel %>%
#     tempogram(window_size = 8, hop_size = 1, cyclic = FALSE) %>%
#     ggplot(aes(x = time, y = bpm, fill = power)) +
#     geom_raster() +
#     scale_fill_viridis_c(guide = "none") +
#     labs(x = "Time (s)", y = "Tempo (BPM)", title = "'Unravel' (10s)") +
#     theme_minimal() + 
#     theme(
#       plot.title = element_text(hjust = 0.5)
#     )

unravel_tempogram
```

***

```{=html}
<img src="https://cdn.myanimelist.net/images/anime/5/64449.jpg" style="width:100%;max-width:282px"/>
<object data="https://open.spotify.com/embed/track/5orAKrVdrk1kPtTa7zNvYL" width="282" height="80" style="display:block;width:282px;margin-bottom:8px;">
    <embed src="https://open.spotify.com/embed/track/5orAKrVdrk1kPtTa7zNvYL" width="282" height="80"></embed>
</object>
```

This is a pretty rare example of a modern anime song that is a bit harder to estimate.
The song contains a few complex rhythmic guitar solos and drum parts. The guitar
solo at 120-145 seconds (2:00-2:25) is almost impossible to estimate using this 
tempogram.

### Tempogram of Tank! (bonus)

```{r, echo=FALSE}
 # bepop <-
 #   get_tidy_audio_analysis("2VqRxxZFbC0uZaTJcZY36c")
 # 
 # bepop_tempogram <-
 #   bepop %>%
 #     tempogram(window_size = 8, hop_size = 1, cyclic = FALSE) %>%
 #     ggplot(aes(x = time, y = bpm, fill = power)) +
 #     geom_raster() +
 #     scale_fill_viridis_c(guide = "none") +
 #     labs(x = "Time (s)", y = "Tempo (BPM)", title = "'Tank!' (90s)") +
 #     theme_minimal() +
 #     theme(
 #       plot.title = element_text(hjust = 0.5)
 #     )

bepop_tempogram
```

***

```{=html}
<img src="https://cdn.myanimelist.net/images/anime/4/19644.jpg" style="width:100%;max-width:282px"/>
<object data="https://open.spotify.com/embed/track/2VqRxxZFbC0uZaTJcZY36c" width="282" height="80" style="display:block;width:282px;margin-bottom:8px;">
    <embed src="https://open.spotify.com/embed/track/2VqRxxZFbC0uZaTJcZY36c" width="282" height="80"></embed>
</object>
```

This is one of my favorite songs of all time, and I really wanted to analyse it.
Unfortunately, I quickly realized I lacked some technical knowledge to properly 
analyse the song in a way that does this song justice. I still wanted to include 
it in my portfolio though, so I hope you enjoy it!

Classification {.storyboard}
=========================================

### Classifying the different playlists (random forest features)

```{r, echo=FALSE}

# ani <-
#   bind_rows(
#     anime_1980s %>% add_audio_analysis() %>% mutate(playlist = "1980s"),
#     anime_1990s %>% add_audio_analysis() %>% mutate(playlist = "1990s"),
#     anime_2000s %>% add_audio_analysis() %>% mutate(playlist = "2000s"),
#     anime_2010s %>% add_audio_analysis() %>% mutate(playlist = "2010s")
#   ) %>%
#   mutate(playlist = factor(playlist)) %>%
#   mutate(
#     segments =
#       map2(segments, key, compmus_c_transpose)
#   ) %>%
#   mutate(
#     pitches =
#       map(segments,
#         compmus_summarise, pitches,
#         method = "mean", norm = "manhattan"
#       ),
#     timbre =
#       map(
#         segments,
#         compmus_summarise, timbre,
#         method = "mean"
#       )
#   ) %>%
#   mutate(pitches = map(pitches, compmus_normalise, "clr")) %>%
#   mutate_at(vars(pitches, timbre), map, bind_rows) %>%
#   unnest(cols = c(pitches, timbre))
# 


# ani_recipe <-
#   recipe(playlist ~
#   danceability +
#     energy +
#     loudness +
#     speechiness +
#     acousticness +
#     instrumentalness +
#     liveness +
#     valence +
#     tempo +
#     duration +
#     C + `C#|Db` + D + `D#|Eb` +
#     E + `F` + `F#|Gb` + G +
#     `G#|Ab` + A + `A#|Bb` + B +
#     c01 + c02 + c03 + c04 + c05 + c06 +
#     c07 + c08 + c09 + c10 + c11 + c12,
#   data = ani
#   ) %>%
#   step_center(all_predictors()) %>%
#   step_scale(all_predictors())
# 
# ani_juice <-
#   ani_recipe %>%
#   # step_range(all_predictors()) %>%
#   prep(ani) %>%
#   juice()
# 
# ani_cv <- ani_juice %>% vfold_cv(10)
# 
# ani_knn <-
#   nearest_neighbor(mode = "classification", neighbors = 1) %>%
#   set_engine("kknn")
# 
# predict_knn_full <-
#   workflow() %>%
#   add_recipe(ani_recipe) %>%
#   add_model(ani_knn) %>%
#   fit_resamples(ani_cv, control = control_resamples(save_pred = TRUE))

# get_conf_mat <- function(fit) {
#   outcome <- .get_tune_outcome_names(fit)
#   fit %>% 
#     collect_predictions() %>% 
#     conf_mat(truth = outcome, estimate = .pred_class)
# }  
# get_pr <- function(fit) {
#   fit %>% 
#     conf_mat_resampled() %>% 
#     group_by(Prediction) %>% mutate(precision = Freq / sum(Freq)) %>% 
#     group_by(Truth) %>% mutate(recall = Freq / sum(Freq)) %>% 
#     ungroup() %>% filter(Prediction == Truth) %>% 
#     select(class = Prediction, precision, recall)
# }  
# 
# predict_knn_full %>% get_pr()
# 
# predict_knn_full %>% mutate(pred = map(splits, predict_knn_reduced)) %>%
#   unnest(pred) %>%
#   conf_mat(truth = playlist, estimate = .pred_class) %>%
#   autoplot(type = "mosaic")
# 
# forest_model <-
#   rand_forest() %>%
#   set_mode("classification") %>% 
#   set_engine("ranger", importance = "impurity")
# 
# ani_forest <-
#   workflow() %>% 
#   add_recipe(ani_recipe) %>% 
#   add_model(forest_model) %>% 
#   fit_resamples(
#     ani_cv, 
#     control = control_resamples(save_pred = TRUE)
#   )

# ani_forest_features <- workflow() %>%
#   add_recipe(ani_recipe) %>%
#   add_model(forest_model) %>%
#   fit(ani) %>%
#   pluck("fit", "fit", "fit") %>%
#   ranger::importance() %>%
#   enframe() %>%
#   mutate(name = fct_reorder(name, value)) %>%
#   ggplot(aes(name, value)) +
#   geom_col() +
#   coord_flip() +
#   theme_minimal() +
#   labs(x = NULL, y = "Importance", title = "Random Forest Feature Importance")

ggplotly(ani_forest_features)

 # predict_knn_reduced <- function(split) {
 #   fit(
 #     ani_knn,
 #     playlist ~ c01 + loudness + speechiness + energy + acousticness + c04,
 #     data = analysis(split)
 #   ) %>%
 #     predict(assessment(split), type = "class") %>%
 #     bind_cols(assessment(split))
 # }
 # 
 # ani_cv %>%
 #   mutate(pred = map(splits, predict_knn_reduced)) %>%
 #   unnest(pred) %>%
 #   conf_mat(truth = playlist, estimate = .pred_class) %>%
 #   autoplot(type = "mosaic")

```
***

This Random Forest gives us the best-quality ranking of feature importance:

* Timbre Component 1 (loudness)
* Loudness 
* speechiness
* Timbre Component 4 (?)
* acousticness
* energy


### Classifying the different playlists (mosaic)

```{r, echo=FALSE}
# ani_mosaic <- ani_cv %>%
#   mutate(pred = map(splits, predict_knn_reduced)) %>%
#   unnest(pred) %>%
#   conf_mat(truth = playlist, estimate = .pred_class) %>%
#   autoplot(type = "mosaic") + 
#   labs(y = "Prediction", title = "Classification Mosaic") + 
#   theme_minimal() +
#   theme(
#       plot.title = element_text(hjust = 0.5)
#   )
# 
# ani_heatmap <- ani_cv %>%
#   mutate(pred = map(splits, predict_knn_reduced)) %>%
#   unnest(pred) %>%
#   conf_mat(truth = playlist, estimate = .pred_class) %>%
#   autoplot(type = "heatmap") + 
#   labs(y = NULL, title = "Classification Heatmap") + 
#   theme_minimal() + 
#   theme(
#       plot.title = element_text(hjust = 0.5)
#   )


# ani_forest %>% get_pr()

ggarrange(ani_mosaic, ani_heatmap, legend = FALSE)
```

***

This mosaic shows the performance of a nearest-neighbor classifier trying to distinguish the
four playlists, after 10-fold cross-validation. The most important features are obtained using
a random-forest classifier (see next card).

The classifier is pretty good at distinguishing anime music from the 80s and the 10s, but struggles
with the 90s and 00s. This is to be expected as the genre evolved clearly but slowly over the years.


Discussion
=========================================

Anime music has been growing steadily for the past 40 years, to the point that a lot of anime songs hit 
mainstream media again just like it had when the anime had its first cultural explosion in the end 70s / early 80s. 

